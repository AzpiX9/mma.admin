/*
 * This source file was generated by the Gradle 'init' task
 */
package org.helmo.mma.admin.app;

import joptsimple.OptionParser;
import joptsimple.OptionSet;
import org.helmo.mma.admin.domains.core.BaseAggregator;
import org.helmo.mma.admin.domains.exceptions.CalendarException;
import org.helmo.mma.admin.infrastructures.BookingAggregator;
import org.helmo.mma.admin.domains.exceptions.DirException;
import org.helmo.mma.admin.infrastructures.*;
import org.helmo.mma.admin.presentations.MainPresenter;
import org.helmo.mma.admin.views.CLIView;

import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;

public class Program {
    private static String path = "";

    public static void main(String[] args) throws DirException, SQLException {
        if(!validGivenArgs(args)){
            throw new DirException("Valeur invalide ou manquante");
        }
        var connValues = path.split(";");
        var dbInfos = connValues[0].split("@");
        var jdbcString = String.format("jdbc:mysql://%s/%s?%s&%s",dbInfos[1],dbInfos[0],connValues[1],connValues[2]);
        BaseAggregator aggregator;
        Connection connection = null;

        try {
            connection = DriverManager.getConnection(jdbcString);
            var roomRepository = new RoomDbRepository(connection);
            var userRepository = new UserDbRepository(connection);
            var calendarRepository = new CalDbRepository(connection);
            var services = new SQLService(new SQLStorage(connection));
            aggregator = new BookingAggregator(roomRepository, userRepository, calendarRepository,services);

        }catch (SQLException e){
            connection.close();
            throw new CalendarException(e.getMessage());
        }

        try(var view = new CLIView(System.in,System.out)){
            var mainPresenter = new MainPresenter(view,aggregator);
            view.run();
            connection.close();
        } catch (IOException e) {
            connection.close();
            throw new DirException(e.getMessage());
        }

    }

    /**
     * Vérifie si les arguments reçus sont valides
     * @param args
     * @return true si l'argument reçu est valide sinon false
     */
    private static boolean validGivenArgs(String[] args) {
        if(args.length < 1) {
            System.err.println("Argument requis db manquant ou incorrect");
            return false;
        }

        if(args.length > 1) {
            System.err.println("Trop arguments donné");
            return false;
        }

        var opts = parsingOpts(args);
        return opts.has("db");
    }

    private static OptionSet parsingOpts(String[] args) {
        OptionParser parser = new OptionParser();
        parser.accepts("db").withRequiredArg();
        var arg = args[0].split("=",2);
        var opts = parser.parse(arg);
        path = opts.valueOf("db").toString();
        return opts;
    }
}
