/*
 * This source file was generated by the Gradle 'init' task
 */
package org.helmo.mma.admin.app;

import joptsimple.OptionParser;
import joptsimple.OptionSet;
import org.helmo.mma.admin.domains.core.BookingAggregator;
import org.helmo.mma.admin.domains.exceptions.DirException;
import org.helmo.mma.admin.infrastructures.ICALViewer;
import org.helmo.mma.admin.infrastructures.RoomFileRepository;
import org.helmo.mma.admin.infrastructures.UserFileRepository;
import org.helmo.mma.admin.presentations.MainPresenter;
import org.helmo.mma.admin.views.CLIView;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;

public class Program {
    private static String path = "";

    public static void main(String[] args) throws DirException {
        if(!validGivenArgs(args)){
            throw new DirException("Valeur invalide ou manquante");
        }

        var roomRepository = new RoomFileRepository(path+"\\rooms.csv");
        var userRepository = new UserFileRepository(path+"\\users.csv");
        var calendarRepository = new ICALViewer(path+"\\Event.ics");

        var aggregator = new BookingAggregator(roomRepository, userRepository, calendarRepository);

        try(var view = new CLIView(System.in,System.out)){
            var mainPresenter = new MainPresenter(view,aggregator);
            view.run();
        } catch (IOException e) {
            throw new RuntimeException(e);
        }

    }

    /**
     * Vérifie si les arguments reçus sont valides
     * @param args
     * @return true si l'argument reçu correspond à un chemin existant et que les 2 fichiers existent sinon false
     */
    private static boolean validGivenArgs(String[] args) {
        if(args.length < 1) {
            System.err.println("Argument requis dir manquant ou incorrect");
            return false;
        }

        if(args.length > 1) {
            System.err.println("Trop arguments donné");
            return false;
        }

        var opts = parsingOpts(args);
        return opts.has("db");
    }

    private static OptionSet parsingOpts(String[] args) {
        OptionParser parser = new OptionParser();
        parser.accepts("db").withRequiredArg();
        var arg = args[0].split("=");
        var opts = parser.parse(arg);
        path = opts.valueOf("db").toString();
        return opts;
    }
}
